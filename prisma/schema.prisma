// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  
  // Role & Plan
  role          UserRole  @default(USER)
  plan          UserPlan  @default(FREE)
  
  // Security & Activity
  isEmailVerified Boolean   @default(false)
  lastLoginAt     DateTime?
  
  // Relations
  accounts        Account[]
  sessions        Session[]
  resumes         Resume[]
  aiInteractions  AIInteraction[]
  subscription    Subscription?
  usageStats      UsageStats?
  jobApplications JobApplication[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([plan])
  @@index([createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Subscription {
  id                    String    @id @default(cuid())
  userId                String    @unique
  
  // Stripe Integration
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  stripePriceId         String?
  stripeProductId       String?
  
  // Subscription Details
  status                String?   // "active", "canceled", "past_due", "trialing"
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean   @default(false)
  canceledAt            DateTime?
  trialStart            DateTime?
  trialEnd              DateTime?
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model UsageStats {
  id              String   @id @default(cuid())
  userId          String   @unique
  
  // Resume Limits
  resumesCreated  Int      @default(0)
  resumesLimit    Int      @default(1)    // FREE: 1, PRO: unlimited (-1)
  
  // AI Credits
  aiCreditsUsed   Int      @default(0)
  aiCreditsLimit  Int      @default(10)   // FREE: 10/month, PRO: 100/month
  
  // Template Access
  premiumTemplatesUsed Boolean @default(false)
  
  // Analytics
  totalViews      Int      @default(0)
  totalDownloads  Int      @default(0)
  
  // Reset tracking
  lastResetAt     DateTime @default(now())
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([userId])
}

// ============================================================================
// RESUME MANAGEMENT
// ============================================================================

enum ResumeStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model Resume {
  id          String        @id @default(cuid())
  userId      String
  
  // Basic Info
  title       String
  description String?       @db.Text
  data        Json          // Complete resume data (personal info, experience, education, etc.)
  
  // Status & Visibility
  status      ResumeStatus  @default(DRAFT)
  isPublic    Boolean       @default(false)
  slug        String?       @unique
  
  // Template & Design
  templateId  String?
  template    Template?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  // AI Features
  aiScore     Float?        // 0-100 quality score
  aiSuggestions Json?       // Structured AI feedback
  lastAIReview  DateTime?   // When was it last analyzed
  
  // Analytics
  viewCount      Int        @default(0)
  downloadCount  Int        @default(0)
  shareCount     Int        @default(0)
  lastViewedAt   DateTime?
  
  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobApplications JobApplication[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([userId])
  @@index([slug])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@index([templateId])
}

// ============================================================================
// TEMPLATES
// ============================================================================

enum TemplateCategory {
  MODERN
  CLASSIC
  CREATIVE
  MINIMALIST
  PROFESSIONAL
  TECHNICAL
}

model Template {
  id          String            @id @default(cuid())
  
  // Basic Info
  name        String
  description String?           @db.Text
  category    TemplateCategory
  
  // Visual
  thumbnail   String?           // Preview image URL
  previewUrl  String?           // Full preview page URL
  
  // Pricing & Access
  isPremium   Boolean           @default(false)
  isActive    Boolean           @default(true)
  
  // Configuration
  structure   Json              // Layout, colors, fonts, section order
  /*
  Example structure:
  {
    "layout": "two-column",
    "colors": {
      "primary": "#3B82F6",
      "secondary": "#10B981",
      "text": "#1F2937",
      "background": "#FFFFFF"
    },
    "fonts": {
      "heading": "Poppins",
      "body": "Inter",
      "sizes": { "name": 32, "heading": 18, "body": 14 }
    },
    "sections": {
      "order": ["header", "summary", "experience", "education", "skills", "projects"],
      "spacing": { "section": 24, "item": 16 }
    },
    "margins": { "top": 40, "right": 40, "bottom": 40, "left": 40 }
  }
  */
  
  // Metadata
  usageCount  Int               @default(0)
  
  // Relations
  resumes     Resume[]
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([category])
  @@index([isPremium])
  @@index([isActive])
  @@index([usageCount])
}

// ============================================================================
// AI INTERACTIONS
// ============================================================================

enum AIActionType {
  GENERATE        // Generate new content
  IMPROVE         // Improve existing content
  ANALYZE         // Analyze resume quality
  SUGGEST         // Provide suggestions
  OPTIMIZE        // Optimize for ATS/keywords
  REWRITE         // Rewrite section
  TRANSLATE       // Translate content
  SUMMARIZE       // Summarize experience
}

model AIInteraction {
  id          String        @id @default(cuid())
  userId      String
  resumeId    String?
  
  // Interaction Details
  type        AIActionType
  prompt      String        @db.Text
  response    String        @db.Text
  context     Json?         // Additional context (section, field, etc.)
  
  // API Usage
  tokensUsed  Int?
  model       String?       // "gpt-4", "claude-3", etc.
  cost        Float?        // Cost in USD
  
  // Metadata
  wasSuccessful Boolean     @default(true)
  errorMessage  String?     @db.Text
  processingTime Int?       // milliseconds
  
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime      @default(now())
  
  @@index([userId])
  @@index([resumeId])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// ============================================================================
// JOB APPLICATION TRACKING
// ============================================================================

enum ApplicationStatus {
  WISHLIST       // Want to apply
  APPLIED        // Application submitted
  SCREENING      // Phone/recruiter screen
  INTERVIEW      // Technical/on-site interview
  OFFER          // Offer received
  ACCEPTED       // Offer accepted
  REJECTED       // Rejected at any stage
  WITHDRAWN      // User withdrew
}

model JobApplication {
  id          String            @id @default(cuid())
  userId      String
  resumeId    String
  
  // Job Details
  company     String
  position    String
  location    String?
  jobUrl      String?           @db.Text
  salary      String?           // "80k-120k" or "$100,000"
  
  // Application Status
  status      ApplicationStatus @default(APPLIED)
  appliedAt   DateTime          @default(now())
  
  // Timeline
  screeningDate   DateTime?
  interviewDate   DateTime?
  offerDate       DateTime?
  responseDate    DateTime?
  deadlineDate    DateTime?
  
  // Notes & Documents
  notes       String?           @db.Text
  coverLetter String?           @db.Text
  
  // Contact Info
  recruiterName  String?
  recruiterEmail String?
  
  // Metadata
  source      String?           // "LinkedIn", "Indeed", "Company Site"
  priority    Int               @default(3)  // 1-5 priority level
  
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume      Resume            @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([userId])
  @@index([resumeId])
  @@index([status])
  @@index([userId, status])
  @@index([appliedAt])
}

// ============================================================================
// ANALYTICS (Optional - for platform-wide insights)
// ============================================================================

model Analytics {
  id          String   @id @default(cuid())
  
  // Event Details
  eventType   String   // "resume_created", "template_selected", "ai_used", etc.
  userId      String?
  resumeId    String?
  
  // Event Data
  metadata    Json?    // Flexible event-specific data
  
  // Context
  ipAddress   String?
  userAgent   String?  @db.Text
  country     String?
  
  createdAt   DateTime @default(now())
  
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@index([eventType, createdAt])
}